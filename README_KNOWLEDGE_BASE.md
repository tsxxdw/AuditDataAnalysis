# 本地知识库功能使用说明

## 功能概述

本地知识库是一个基于向量数据库的文档存储和检索系统，支持以下功能：

1. 文件上传：支持上传docx、doc、txt格式的文档到知识库
2. 文本直接录入：支持直接输入文本内容并添加到知识库
3. 智能分块：根据文档类型（法律文档、审计报告等）自动选择合适的分块策略
4. 语义搜索：基于向量相似度的语义搜索，而非简单的关键词匹配
5. 知识库管理：查看、搜索和删除知识库中的内容

## 技术实现

* 向量化模型：使用Ollama中的nomic-embed-text模型生成文本嵌入向量
* 向量数据库：使用Milvus存储和检索文本向量
* 分块策略：针对不同类型文档（法律文件、审计报告等）实现了专门的分块策略

## 系统需求

使用本地知识库功能需要满足以下条件：

1. 安装Ollama并下载nomic-embed-text模型
   ```
   ollama pull nomic-embed-text:latest
   ```

2. 安装并启动Milvus向量数据库
   ```
   docker run -d --name milvus-standalone -p 19530:19530 -p 9091:9091 milvusdb/milvus:latest standalone
   ```

3. 安装必要的Python依赖
   ```
   pip install pymilvus==2.2.8 docx2txt==0.8 python-docx==0.8.11
   ```

## 文档分块策略

根据不同的文档类型，系统采用不同的分块策略：

### 法律文件
* 按法条切割：每条法律作为独立文本块
* 例如：《民法典》第584条作为一个完整块
* 识别特征：包含"第X条"、"法律"、"条例"等关键词

### 审计报告
* 三层分级切割：
  1. 全文摘要（作为1个块）
  2. 按章节切割（如"审计问题"章节=1个块）
  3. 关键表格单独存储
* 识别特征：包含"审计报告"、"审计发现"、"财务"等关键词

### 普通文档
* 按段落智能分块，合并过短的段落
* 默认块大小：1000字符

## 使用方法

### 1. 文件上传
1. 在首页点击"本地知识库"进入知识库页面
2. 在"文件上传"标签页选择或拖放文件
3. 点击"上传到知识库"按钮

### 2. 文本录入
1. 切换到"文本录入"标签页
2. 填写知识标题、内容和标签（标签用逗号分隔）
3. 点击"保存到知识库"按钮

### 3. 搜索知识库
1. 切换到"知识库列表"标签页
2. 在搜索框中输入查询内容
3. 选择过滤类型（可选）
4. 点击"搜索"按钮

### 4. 管理知识库
1. 在"知识库列表"标签页查看所有知识库项目
2. 点击项目上的图标可以查看或删除知识

## 注意事项

1. 首次使用需确保Ollama服务和Milvus向量数据库已正确启动
2. 大文件处理可能需要较长时间
3. 删除知识库项目操作不可撤销
4. 目前仅支持中文和英文文档

## 智能问答功能

最新版本的本地知识库已添加智能问答功能，允许用户通过大语言模型查询知识库中的内容。

### 功能特点

1. **基于知识库内容回答问题**：系统会先检索与问题相关的内容，然后基于这些内容提供专业的回答
2. **智能引用来源**：回答将显示引用的知识库内容来源，帮助用户判断信息的可靠性
3. **对话历史记忆**：系统保存对话历史，使对话更连贯，并自动限制历史长度避免上下文过长
4. **适用于专业内容**：优化了针对审计和法律文档的提示模板，能够更好地回答专业问题
5. **Markdown格式支持**：系统回复支持Markdown格式，包括标题、列表、表格、代码块等，提高可读性
6. **特定模型优化**：针对不同模型（如Qwen3）进行了特殊优化，提高回答质量

### 使用方法

1. 打开"本地知识库"页面
2. 点击顶部的"智能问答"标签
3. 在输入框中输入您的问题
4. 系统会自动检索知识库，并利用大模型生成回答

### 技术实现

该功能基于以下技术实现：
- 使用向量数据库进行语义搜索
- 使用系统设置的默认大语言模型提供推理能力
- 优化的提示工程确保回答质量
- 前端流畅的聊天界面体验

### 注意事项

1. 使用前请确保已设置系统默认模型
2. 系统会自动检测默认模型和可用模型并显示状态
3. 推荐使用的模型：qwen（通义千问）、llama3等通用大语言模型
4. 回答质量取决于知识库内容的质量和相关性以及所选模型的能力

### 如何设置默认模型

1. 进入系统设置页面
2. 选择"模型设置"标签页
3. 在可用模型列表中选择一个模型作为默认模型
4. 点击"设置为默认"按钮保存设置 